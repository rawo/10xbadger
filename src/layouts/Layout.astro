---
import "../styles/global.css";
import { Toaster } from "@/components/ui/toaster";
import { UserMenu } from "@/components/navigation/UserMenu";
import { ThemeToggle } from "@/components/ui/theme-toggle";
import { getAuthenticatedUser } from "@/lib/auth/server-auth";

interface Props {
  title?: string;
  user?: {
    id: string;
    email: string;
    display_name: string;
    is_admin: boolean;
  } | null;
}

const { title = "10xbadger", user: propsUser = null } = Astro.props;

// Server-side user state verification
// If user is not provided via props, check session on the server
let user = propsUser;
if (!user) {
  try {
    user = await getAuthenticatedUser(Astro);
  } catch {
    // Silent fail - user is not authenticated
  }
}

// Check if current page is login, logout, or unauthorized
const isAuthPage = [
  "/login",
  "/logout",
  "/unauthorized",
  "/register",
  "/forgot-password",
  "/reset-password",
  "/verify-email",
].some((path) => Astro.url.pathname.startsWith(path));

// Track authentication state for client-side components
const isAuthenticated = user !== null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <script is:inline>
      (function () {
        try {
          const t = localStorage.getItem("theme");
          const theme = t || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
          if (theme === "dark") document.documentElement.classList.add("dark");
        } catch {
          // Ignore errors
        }
      })();
    </script>
  </head>
  <body data-authenticated={isAuthenticated}>
    <!-- Navigation Header (hidden on auth pages) -->
    {
      !isAuthPage && (
        <header class="border-border sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur">
          <div class="container mx-auto flex h-16 items-center justify-between px-4">
            {/* Logo and App Name */}
            <div class="flex items-center gap-2">
              <a href="/" class="flex items-center gap-2 transition-opacity hover:opacity-80">
                <div class="bg-primary/10 flex size-8 items-center justify-center rounded-lg">
                  <svg
                    class="text-primary size-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
                    />
                  </svg>
                </div>
                <span class="text-lg font-semibold">10xbadger</span>
              </a>
            </div>

            {/* Navigation Links (when authenticated) */}
            {user && (
              <nav class="hidden md:flex items-center gap-1" role="navigation" aria-label="Main navigation">
                <a
                  href="/"
                  class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                  aria-current={Astro.url.pathname === "/" ? "page" : undefined}
                >
                  Dashboard
                </a>
                <a
                  href="/catalog"
                  class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                  aria-current={Astro.url.pathname.startsWith("/catalog") ? "page" : undefined}
                >
                  Catalog
                </a>
                <a
                  href="/applications"
                  class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                  aria-current={Astro.url.pathname.startsWith("/applications") ? "page" : undefined}
                >
                  Applications
                </a>
                <a
                  href="/promotion-templates"
                  class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                  aria-current={Astro.url.pathname.startsWith("/promotion-templates") ? "page" : undefined}
                >
                  Templates
                </a>
                <a
                  href="/promotions"
                  class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                  aria-current={Astro.url.pathname.startsWith("/promotions") ? "page" : undefined}
                >
                  Promotions
                </a>
                {user.is_admin && (
                  <a
                    href="/admin/review"
                    class="hover:bg-accent rounded-md px-3 py-2 text-sm font-medium transition-colors"
                    aria-current={Astro.url.pathname.startsWith("/admin") ? "page" : undefined}
                  >
                    Admin
                  </a>
                )}
              </nav>
            )}

            {/* User Menu or Sign In Button */}
            <div class="flex items-center gap-2">
              {user ? (
                <UserMenu client:load user={user} />
              ) : (
                <>
                  <ThemeToggle client:load />
                  <a
                    href="/login"
                    class="hover:bg-primary/90 bg-primary text-primary-foreground inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-medium transition-colors"
                  >
                    Sign In
                  </a>
                </>
              )}
            </div>
          </div>
        </header>
      )
    }

    <!-- Main Content -->
    <slot />

    <!-- Toast Notifications -->
    <Toaster client:load />
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
