---
import Layout from "@/layouts/Layout.astro";
import { ApplicationEditor } from "@/components/badge-applications/ApplicationEditor";
import { CatalogBadgesView } from "@/components/catalog-badges/CatalogBadgesView";
import type { CatalogBadgeDetailDto, ApiError } from "@/types";
import { UUID_REGEX } from "@/lib/validation/uuid";

/**
 * New Badge Application Page
 *
 * Server-side rendered page for creating a new badge application.
 * Requires catalog_badge_id query parameter to specify which badge to apply for.
 *
 * ⚠️  DEVELOPMENT MODE: Authentication is currently DISABLED
 * TODO: Re-enable authentication before production deployment
 */

// =========================================================================
// DEVELOPMENT MODE: Authentication Disabled
// =========================================================================
// TODO: Re-enable authentication before production deployment

const userId = "550e8400-e29b-41d4-a716-446655440100"; // Default user from sample data

// =========================================================================
// PRODUCTION CODE (Currently Disabled)
// =========================================================================
// Uncomment the code below when authentication is ready:
/*
const supabase = Astro.locals.supabase;

// Check authentication
const { data: { user }, error: authError } = await supabase.auth.getUser();
if (authError || !user) {
  return Astro.redirect('/login?return=/apply/new');
}

const userId = user.id;
*/

// =========================================================================
// Determine behavior: if a catalog_badge_id is provided we load the badge,
// otherwise we show an embedded catalog selector so users can pick a badge.
// =========================================================================

const catalogBadgeId = Astro.url.searchParams.get("catalog_badge_id");
const baseUrl = Astro.url.origin;
let catalogBadge: CatalogBadgeDetailDto | null = null;
let error: string | null = null;
let showCatalogSelector = false;
let showInactiveWarning = false;

if (!catalogBadgeId) {
  // No badge selected — show embedded catalog to let the user pick one.
  showCatalogSelector = true;
} else {
  // Basic UUID validation
  if (!UUID_REGEX.test(catalogBadgeId)) {
    // Invalid UUID format - redirect to catalog
    return Astro.redirect("/catalog");
  }

  // Fetch Catalog Badge Data
  try {
    const response = await fetch(`${baseUrl}/api/catalog-badges/${catalogBadgeId}`, {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    if (response.status === 404) {
      // Badge not found
      error = "Catalog badge not found";
    } else if (response.status === 401) {
      // Unauthorized - redirect to login
      return Astro.redirect("/login?return=" + encodeURIComponent(Astro.url.pathname + Astro.url.search));
    } else if (!response.ok) {
      const apiError: ApiError = await response.json();
      error = apiError.message || "Failed to fetch catalog badge";
    } else {
      catalogBadge = await response.json();
    }
  } catch (e) {
    // eslint-disable-next-line no-console
    console.error("Error fetching catalog badge:", e);
    error = "Failed to load catalog badge data";
  }

  // Handle fetch errors
  if (error || !catalogBadge) {
    // Show error page
    return Astro.response.redirect("/catalog?error=" + encodeURIComponent(error || "Badge not found"));
  }

  // Check if badge is inactive
  showInactiveWarning = catalogBadge.status === "inactive";
}
---

<Layout title="New Badge Application - Badger">
  <main class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      {
        showInactiveWarning && (
          <div class="mb-6 rounded-lg border border-warning bg-warning/10 p-4">
            <div class="flex items-start gap-3">
              <svg
                class="h-5 w-5 text-warning flex-shrink-0 mt-0.5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
              </svg>
              <div>
                <h3 class="font-semibold text-warning">This badge is no longer active</h3>
                <p class="text-sm text-warning/80 mt-1">
                  You can save this application as a draft, but submission may not be possible.
                </p>
              </div>
            </div>
          </div>
        )
      }

      {
        showCatalogSelector ? (
          // If no badge selected, show an embedded catalog selector so users can choose a badge.
          // Provide an empty initial dataset; the client hook will fetch real data on mount.
          <CatalogBadgesView
            client:load
            initialData={{ data: [], pagination: { total: 0, limit: 20, offset: 0, has_more: false } }}
            isAdmin={false}
          />
        ) : (
          <ApplicationEditor client:load mode="create" catalogBadge={catalogBadge} userId={userId} />
        )
      }
    </div>
  </main>
</Layout>
