---
import Layout from "../layouts/Layout.astro";
import { DashboardView } from "@/components/dashboard/DashboardView";
import type {
  DashboardViewModel,
  PaginatedResponse,
  BadgeApplicationListItemDto,
  PromotionListItemDto,
} from "@/types";

/**
 * Dashboard Page (Home)
 *
 * Server-side rendered page that fetches initial data for the dashboard.
 * Displays user's badge applications, promotions, and quick statistics.
 *
 * ⚠️  DEVELOPMENT MODE: Authentication is currently DISABLED
 * TODO: Re-enable authentication before production deployment
 */

// =========================================================================
// DEVELOPMENT MODE: Authentication Disabled
// =========================================================================
// TODO: Re-enable authentication before production deployment
// For now, we use a default user ID for development

const userId = "550e8400-e29b-41d4-a716-446655440100"; // Default user from sample data

// =========================================================================
// PRODUCTION CODE (Currently Disabled)
// =========================================================================
// Uncomment the code below when authentication is ready:
/*
const supabase = Astro.locals.supabase;

// Check authentication
const { data: { user }, error: authError } = await supabase.auth.getUser();
if (authError || !user) {
  return Astro.redirect('/login');
}

const userId = user.id;
*/

// =========================================================================
// Data Fetching: Badge Applications and Promotions
// =========================================================================

const baseUrl = Astro.url.origin;

// Helper function to fetch with error handling
async function fetchData<T>(url: string): Promise<T | null> {
  try {
    const response = await fetch(url, {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    if (!response.ok) {
      console.error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
      return null;
    }

    return await response.json();
  } catch (error) {
    console.error(`Error fetching ${url}:`, error);
    return null;
  }
}

// Fetch all data in parallel
const [
  draftAppsResponse,
  submittedAppsResponse,
  acceptedAppsResponse,
  rejectedAppsResponse,
  draftPromosResponse,
  submittedPromosResponse,
  approvedPromosResponse,
  rejectedPromosResponse,
] = await Promise.all([
  fetchData<PaginatedResponse<BadgeApplicationListItemDto>>(
    `${baseUrl}/api/badge-applications?status=draft&limit=10&sort=created_at&order=desc`
  ),
  fetchData<PaginatedResponse<BadgeApplicationListItemDto>>(
    `${baseUrl}/api/badge-applications?status=submitted&limit=10&sort=submitted_at&order=desc`
  ),
  fetchData<PaginatedResponse<BadgeApplicationListItemDto>>(
    `${baseUrl}/api/badge-applications?status=accepted&limit=10&sort=created_at&order=desc`
  ),
  fetchData<PaginatedResponse<BadgeApplicationListItemDto>>(
    `${baseUrl}/api/badge-applications?status=rejected&limit=10&sort=created_at&order=desc`
  ),
  fetchData<PaginatedResponse<PromotionListItemDto>>(
    `${baseUrl}/api/promotions?status=draft&limit=10&sort=created_at&order=desc`
  ),
  fetchData<PaginatedResponse<PromotionListItemDto>>(
    `${baseUrl}/api/promotions?status=submitted&limit=10&sort=submitted_at&order=desc`
  ),
  fetchData<PaginatedResponse<PromotionListItemDto>>(
    `${baseUrl}/api/promotions?status=approved&limit=10&sort=created_at&order=desc`
  ),
  fetchData<PaginatedResponse<PromotionListItemDto>>(
    `${baseUrl}/api/promotions?status=rejected&limit=10&sort=created_at&order=desc`
  ),
]);

// =========================================================================
// Transform Data into DashboardViewModel
// =========================================================================

const dashboardData: DashboardViewModel = {
  badgeApplications: {
    draft: draftAppsResponse?.data || [],
    submitted: submittedAppsResponse?.data || [],
    accepted: acceptedAppsResponse?.data || [],
    rejected: rejectedAppsResponse?.data || [],
  },
  promotions: {
    draft: draftPromosResponse?.data || [],
    submitted: submittedPromosResponse?.data || [],
    approved: approvedPromosResponse?.data || [],
    rejected: rejectedPromosResponse?.data || [],
  },
  statistics: {
    draftApplicationsCount: draftAppsResponse?.pagination.total || 0,
    submittedApplicationsCount: submittedAppsResponse?.pagination.total || 0,
    acceptedBadgesCount: acceptedAppsResponse?.pagination.total || 0,
    rejectedApplicationsCount: rejectedAppsResponse?.pagination.total || 0,
    draftPromotionsCount: draftPromosResponse?.pagination.total || 0,
    submittedPromotionsCount: submittedPromosResponse?.pagination.total || 0,
    approvedPromotionsCount: approvedPromosResponse?.pagination.total || 0,
    rejectedPromotionsCount: rejectedPromosResponse?.pagination.total || 0,
  },
};
---

<Layout title="Dashboard - Badger">
  <main class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-foreground mb-8">Dashboard</h1>

      <!-- DashboardView React Component with client-side interactivity -->
      <DashboardView client:load initialData={dashboardData} userId={userId} />
    </div>
  </main>
</Layout>
